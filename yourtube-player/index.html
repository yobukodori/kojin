<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YouTubeæ¤œç´¢ã¨åŸ‹ã‚è¾¼ã¿</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #results, #relatedList { margin-top: 20px; }
    li { margin-bottom: 12px; }

    #modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
    }
    #modalContent {
      position: relative;
      margin: 5% auto;
      width: 90%;
      height: 90%;
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
    }
    #closeBtn {
      position: absolute;
      top: 10px; right: 20px;
      font-size: 24px;
      cursor: pointer;
    }
    #modalLayout {
      display: flex;
      height: 100%;
    }
    #modalLeft {
      flex: 2;
      padding: 10px;
    }
    #modalRight {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-left: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>YouTubeæ¤œç´¢ï¼ˆHTMLè§£æï¼‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼‰</h2>
  <input type="text" id="searchKeyword" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" size="50">
  <button onclick="searchYouTube()">Search</button>

  <ul id="results"></ul>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="modal">
    <div id="modalContent">
      <span id="closeBtn" onclick="closeModal()">Ã—</span>
      <div id="modalLayout">
        <div id="modalLeft">
          <div id="modalPlayer"></div>
        </div>
        <div id="modalRight">
          <h3>é–¢é€£å‹•ç”»</h3>
          <ul id="relatedList"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('searchKeyword').addEventListener('keydown', event => {
        if (event.key === 'Enter') searchYouTube();
      });
    });

    async function searchYouTube() {
      const keyword = document.getElementById('searchKeyword').value;
      if (!keyword) return;

      const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(keyword)}`;
      const response = await fetch(searchUrl);
      const htmlText = await response.text();

      const jsonMatch = htmlText.match(/var ytInitialData = (.*?);<\/script>/);
      if (!jsonMatch) return;

      let jsonText = jsonMatch[1].trim();
      if (jsonText.endsWith(';')) jsonText = jsonText.slice(0, -1);
      const ytData = JSON.parse(jsonText);

      const items = extractSearchResults(ytData);
      const resultsList = document.getElementById('results');
      resultsList.innerHTML = '';

      items.forEach(item => {
        const li = document.createElement('li');

        const titleLink = document.createElement('a');
        titleLink.href = "#";
        titleLink.textContent = item.title;
        titleLink.style.display = "block";
        titleLink.onclick = () => showModal(item.videoId);

        const channelText = document.createElement('span');
        channelText.textContent = `ãƒãƒ£ãƒ³ãƒãƒ«: ${item.channel}`;
        channelText.style.display = "block";
        channelText.style.fontSize = "0.9em";
        channelText.style.color = "#555";

        li.appendChild(titleLink);
        li.appendChild(channelText);
        resultsList.appendChild(li);
      });
    }

    function extractSearchResults(data) {
      const results = [];
      const contents = data.contents?.twoColumnSearchResultsRenderer?.primaryContents?.sectionListRenderer?.contents || [];
      for (const section of contents) {
        const items = section.itemSectionRenderer?.contents || [];
        for (const item of items) {
          const video = item.videoRenderer;
          if (video) {
            const title = video.title?.runs?.map(r => r.text).join("") || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
            const channel = video.ownerText?.runs?.[0]?.text || "ãƒãƒ£ãƒ³ãƒãƒ«ä¸æ˜";
            results.push({ videoId: video.videoId, title, channel });
          }
        }
      }
      return results;
    }

    function showModal(videoId) {
      const modal = document.getElementById('modal');
      const modalPlayer = document.getElementById('modalPlayer');
      modalPlayer.innerHTML = `
        <iframe width="100%" height="315"
          src="https://www.youtube.com/embed/${videoId}?autoplay=1"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
      `;
      modal.style.display = 'block';
      fetchRelatedVideos(videoId);
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      document.getElementById('modalPlayer').innerHTML = '';
      document.getElementById('relatedList').innerHTML = '';
    }

function tracePropertyPaths(obj, targetKey = "shortBylineText", path = "ytData") {
  if (typeof obj !== "object" || obj === null) return;

  for (const key in obj) {
    if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;

    const newPath = `${path}.${key}`;

    if (key === targetKey) {
      console.log(`ğŸ” [trace] è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${newPath}`);
    }

    tracePropertyPaths(obj[key], targetKey, newPath);
  }
}

async function fetchRelatedVideos(videoId) {
  const url = `https://www.youtube.com/watch?v=${videoId}`;
  console.log(`ğŸ” [fetchRelatedVideos] é–‹å§‹: ${url}`);

  try {
    const response = await fetch(url);
    if (!response.ok) {
      console.error(`âŒ HTTPã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
      return;
    }

    const htmlText = await response.text();
    console.log(`âœ… HTMLå–å¾—æˆåŠŸ (${htmlText.length}æ–‡å­—)`);

    const jsonMatch = htmlText.match(/var ytInitialData = (.*?);<\/script>/);
    if (!jsonMatch || jsonMatch.length < 2) {
      console.error("âŒ ytInitialData ã®æŠ½å‡ºã«å¤±æ•—");
      return;
    }

    let jsonText = jsonMatch[1].trim();
    if (jsonText.endsWith(';')) jsonText = jsonText.slice(0, -1);

    let ytData;
    try {
      ytData = JSON.parse(jsonText);
      console.log("âœ… JSON ãƒ‘ãƒ¼ã‚¹æˆåŠŸ");
    } catch (err) {
      console.error("âŒ JSON.parse ã‚¨ãƒ©ãƒ¼:", err);
      console.log("ğŸ” JSONãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…ˆé ­500æ–‡å­—ï¼‰:", jsonText.slice(0, 500));
      return;
    }

    // ğŸ” shortBylineText ã®æ¢ç´¢ãƒ­ã‚°å‡ºåŠ›
    console.log("ğŸ” [trace] shortBylineText ã®æ¢ç´¢é–‹å§‹");
    tracePropertyPaths(ytData, "shortBylineText", "ytData");

    const secondary = ytData.playerOverlays?.playerOverlayRenderer?.endScreen?.watchNextEndScreenRenderer?.results;
    if (!Array.isArray(secondary)) {
      console.error("âŒ endScreen.results ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      console.log("ğŸ” ytData.playerOverlays:", ytData.playerOverlays);
      return;
    }

    console.log(`âœ… é–¢é€£å‹•ç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³å–å¾—æˆåŠŸï¼ˆ${secondary.length}ä»¶ï¼‰`);

    const relatedList = document.getElementById('relatedList');
    if (!relatedList) {
      console.error("âŒ DOMè¦ç´  #relatedList ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }

    relatedList.innerHTML = '';
    const seen = new Set();
    let addedCount = 0;

    for (const item of secondary) {
      const video = item.endScreenVideoRenderer;
      if (!video) {
        console.warn("âš ï¸ endScreenVideoRenderer ãŒå­˜åœ¨ã—ãªã„é …ç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—");
        continue;
      }

      const id = video.videoId;
      if (!id || seen.has(id)) {
        console.warn(`âš ï¸ videoId ãŒç„¡åŠ¹ã¾ãŸã¯é‡è¤‡: ${id}`);
        continue;
      }
      seen.add(id);

      let title = "";
      if (video.title?.simpleText) {
        title = video.title.simpleText;
      } else if (Array.isArray(video.title?.runs)) {
        title = video.title.runs.map(run => run.text).join("");
      } else {
        console.warn(`âš ï¸ ã‚¿ã‚¤ãƒˆãƒ«å–å¾—å¤±æ•—: videoId=${id}`);
        continue;
      }

      const channel = video.shortBylineText?.runs?.[0]?.text || "ãƒãƒ£ãƒ³ãƒãƒ«ä¸æ˜";

      const li = document.createElement('li');

      const titleLink = document.createElement('a');
      titleLink.href = "#";
      titleLink.textContent = title;
      titleLink.style.display = "block";
      titleLink.onclick = () => showModal(id);

      const channelText = document.createElement('span');
      channelText.textContent = `ãƒãƒ£ãƒ³ãƒãƒ«: ${channel}`;
      channelText.style.display = "block";
      channelText.style.fontSize = "0.9em";
      channelText.style.color = "#555";

      li.appendChild(titleLink);
      li.appendChild(channelText);
      relatedList.appendChild(li);
      addedCount++;
    }

    console.log(`âœ… é–¢é€£å‹•ç”»ãƒªã‚¹ãƒˆã« ${addedCount} ä»¶è¿½åŠ ã—ã¾ã—ãŸ`);
    if (addedCount === 0) {
      console.warn("âš ï¸ è¡¨ç¤ºå¯èƒ½ãªé–¢é€£å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    }

  } catch (error) {
    console.error("âŒ fetchRelatedVideos å…¨ä½“ã®ä¾‹å¤–:", error);
  }
}
  </script>
</body>
</html>